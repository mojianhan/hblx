define(["jquery","weui"],function(e,t){"use strict";var D=a(e),H=a(t);function a(e){return e&&e.__esModule?e:{default:e}}!function(){var i=null,o=[],s=0,n="",d=null,r=250,u=null,e=3,t=document.getElementById("audio-msc"),c=document.getElementById("body-bg"),a=document.documentElement.clientHeight,f="",m="",p="",h=1,v="",b=!0,g=30,_=localStorage.getItem("CODE"),C=localStorage.getItem("ACTIVE_NUMBER"),y=0,I={open_id:"",nickname:"",headimgurl:""};function l(e,t){D.default.ajax({url:"/tools/competition-set/post-selected.do",type:"POST",data:{activity_number:e,open_id:t},success:function(e){200==e.status&&(n=e.data.player_info.uuid)},error:function(e){H.default.alert(e.data.errMsg)}})}x=_,D.default.ajax({url:"/tools/user/get-one.do",type:"GET",data:{code:x},success:function(e){var t,a;200===e.status&&(I.headimgurl=e.data.headimgurl,I.open_id=e.data.open_id,I.nickname=e.data.nickname,(0,D.default)(".user-img").attr("src",e.data.headimgurl),y++,t=e.data.open_id,a=C,D.default.ajax({url:"/tools/tools-crm/get-selected.do",type:"GET",data:{open_id:t,activity_number:a},success:function(e){var t=e.data.player_info;return Number(t.already_participate_number)>=Number(e.data.distribution_info.total_participate_times)?((0,D.default)(".audio-music")[0].pause(),(0,D.default)(".score-alert").text(s+"分"),u&&clearInterval(u),d&&clearInterval(d),M&&clearInterval(M),(0,D.default)(".error-alert-container").removeClass("hidden"),(0,D.default)('.error-status[data-status="5"]').removeClass("hidden").siblings().addClass("hidden"),void(0,D.default)(".confim-msg").off().on("click",function(){location.href="./?code="+_+"&state="+C})):0==Number(t.use_participate_number)&&0==Number(t.use_share_number)?((0,D.default)(".audio-music")[0].pause(),(0,D.default)(".score-alert").text(s+"分"),u&&clearInterval(u),d&&clearInterval(d),M&&clearInterval(M),(0,D.default)(".error-alert-close").addClass("hidden"),(0,D.default)(".error-alert-container").removeClass("hidden"),(0,D.default)('.error-status[data-status="4"]').removeClass("hidden").siblings().addClass("hidden"),(0,D.default)(".share-btn").addClass("hidden"),void(0,D.default)(".confim-msg").off().on("click",function(){location.href="./?code="+_+"&state="+C})):0==Number(t.use_participate_number)&&0<Number(t.use_share_number)?((0,D.default)(".audio-music")[0].pause(),(0,D.default)(".score-alert").text(s+"分"),(0,D.default)(".error-alert-close").addClass("hidden"),u&&clearInterval(u),d&&clearInterval(d),M&&clearInterval(M),(0,D.default)(".error-alert-container").removeClass("hidden"),(0,D.default)('.error-status[data-status="3"]').removeClass("hidden").siblings().addClass("hidden"),(0,D.default)("#share-btn").removeClass("hidden"),void(0,D.default)(".confim-msg").off().on("click",function(){location.href="./?code="+_+"&state="+C})):void 0},error:function(e){H.default.alert(e.data.errMsg)}}),l(C,e.data.open_id),2==y&&S())},error:function(){u&&clearInterval(u),d&&clearInterval(d),M&&clearInterval(M),H.default.alert("用户未登录,请先登陆"),location.href="http://dev.commodity.crm.9daye.com.cn/active/"}}),k=C,D.default.ajax({url:"/tools/tools-crm/get-all.do",type:"GET",data:{activity_number:k},success:function(e){if(200==e.status){var t=e.data.toolsSetting_info,a=e.data.setting_info,l=e.data.distribution_info;0==t.status&&(H.default.alert("活动已结束！"),u&&clearInterval(u),d&&clearInterval(d),M&&clearInterval(M)),1==t.status&&(H.default.alert("活动还未开始！"),u&&clearInterval(u),d&&clearInterval(d),M&&clearInterval(M)),1==a.bottom_button&&(0,D.default)('.follow[data-id="follow-us"]').removeClass("hidden"),1==a.background_music_status?((0,D.default)(".audio-music")[0].play(),(0,D.default)(".music").removeClass("music-disable"),b=!0):((0,D.default)(".audio-music")[0].pause(),(0,D.default)(".music").addClass("music-disable"),b=!1);var n=navigator.userAgent,i=!!n.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/);if(i&&((0,D.default)(".audio-music")[0].pause(),b=!1,(0,D.default)(".music").addClass("music-disable")),0==a.participate_number_limit_status){var o=Number(e.data.participate_number),s=Number(a.participate_number_limit);s<=o&&(H.default.alert("当前参与人数已满，无法再参与!"),(0,D.default)(".audio-music")[0].pause(),(0,D.default)(".music").addClass("music-disable"),u&&clearInterval(u),d&&clearInterval(d),M&&clearInterval(M))}2==++y&&S(),f=a.distribution_type,m=t.start_time,p=t.end_time,v=2==f?l.lottery_limit:""}},error:function(){u&&clearInterval(u),d&&clearInterval(d),M&&clearInterval(M),(0,D.default)(".audio-music")[0].pause(),b=!1,(0,D.default)(".music").addClass("music-disable"),H.default.alert("未获取到活动信息，请重新登陆！"),location.href="http://dev.commodity.crm.9daye.com.cn/active/"}});var k;var x;var M=setInterval(T,1e3);function T(){g=-1<(g-=1)?g:0,(0,D.default)(".game-time").text(g+"s")}function S(){setTimeout(function(){var e,t,a,l;M&&clearInterval(M),y=0,u&&clearInterval(u),d&&clearInterval(d),M&&clearInterval(M),(0,D.default)(".audio-music")[0].pause(),(0,D.default)(".music").addClass("music-disable"),b=!1,(0,D.default)(".game-over-alert-container").removeClass("hidden"),(0,D.default)(".score-alert").text(s+"分"),e=C,t=I.open_id,a=s,l=n,D.default.ajax({url:"/tools/competition-set/put-one.do",type:"POST",data:{activity_number:e,open_id:t,score:a,uuid:l},success:function(e){if(200==e.status){(0,D.default)(".best-score").text(e.data.highest_score||"暂无");var t=e.data.prize_info.use_participate_number||0;3==f?((0,D.default)(".reminder-msg").text("您还有"+t+"次游戏机会!"),Object.keys(e.data.prize_info.order_info)[0]?(0,D.default)(".score-ranking-list").text(Object.keys(e.data.prize_info.order_info)[0]):(0,D.default)(".score-ranking-list").text("暂无")):((0,D.default)(".reminder-msg").text("返回首页").off().on("click",function(){location.href="/?code="+_+"&state="+C}),(0,D.default)(".to-index").addClass("hidden")),2==f&&((0,D.default)(".score-ranking-list-container").addClass("hidden"),a<v?((0,D.default)(".game-over-alert-list-container").addClass("failed-alert-container"),(0,D.default)(".failed-reason").removeClass("hidden").text("成绩必须达到"+v+"分才能获得奖品")):(0,D.default)(".to-prize").removeClass("hidden").off().on("click",function(){location.href="./?code="+_+"&state="+C+"&showTip=2"}))}}})},1e3*(g+1))}function w(e){s+(e-=0)<0?s=0:s+=e,(0,D.default)("#score").text(s)}function E(){(0,D.default)(".game-over-alert-container").addClass("hidden"),g=30,h=1,r=250,(s=0,D.default)("#score").text(s),o=[],c.innerHTML="",u&&clearInterval(u),d&&clearInterval(d),M&&clearInterval(M),M=setInterval(T,1e3),u=setInterval(W,r),d=setInterval(j,h),b=!0,(t.currentTime=0,D.default)(".audio-music")[0].play(),(0,D.default)(".music").removeClass("music-disable"),l(C,I.open_id),S()}function j(){if(null!=o)for(var e=0;e<o.length;e++){var t=parseInt(o[e].style.top.substring(0,3));t+=h,o[e].style.top=t+"px",15==g&&(h=2,r=100),A(o[e],q)&&(w(A(o[e],q)),5==A(o[e],q)&&((0,D.default)("#puppet").addClass("get-score5"),setTimeout(function(){(0,D.default)("#puppet").removeClass("get-score5")},200)),10==A(o[e],q)&&((0,D.default)("#puppet").addClass("get-score10"),setTimeout(function(){(0,D.default)("#puppet").removeClass("get-score10")},200)),-20==A(o[e],q)&&((0,D.default)("#puppet").addClass("lose-score20"),(0,D.default)("#puppet").addClass("puppet-bomb"),setTimeout(function(){(0,D.default)("#puppet").removeClass("lose-score20"),(0,D.default)("#puppet").removeClass("puppet-bomb")},200)),c.removeChild(o[e]),o.splice(e,1)),a-100<t&&(c.removeChild(o[e]),o.splice(e,1))}}function W(){!function(e){var t=Math.floor(e/10*100),a=Math.floor((100-t)/2)+t+10;if(9<e||e<1)return;i=document.createElement("span");var l=Math.floor(100*Math.random())+1;l<t&&(i.setAttribute("class","bomb"),i.setAttribute("data-value",-20));t<=l&&l<a&&(i.setAttribute("class","money"),i.setAttribute("data-value",5));a<=l&&(i.setAttribute("class","money-db"),i.setAttribute("data-value",10));c.appendChild(i);var n=Math.floor(10*Math.random())*i.offsetWidth;n+i.offsetWidth>document.documentElement.clientWidth&&(n=document.documentElement.clientWidth-i.offsetWidth);i.style.left=n+"px",i.style.top="100px",o.push(i)}(e)}function A(e,t){if(null!=e&&null!=t){var a=e.offsetTop,l=e.offsetTop+e.offsetHeight,n=e.offsetLeft,i=e.offsetLeft+e.offsetWidth,o=e.offsetLeft+e.offsetWidth/2,s=t.offsetTop,d=t.offsetTop+t.offsetHeight,r=t.offsetLeft,u=t.offsetLeft+t.offsetWidth,c=t.offsetLeft+t.offsetWidth/2;return c-30<o&&o<c+30&&s<l&&r<i&&a<d&&n<u&&l<s+20?e.getAttribute("data-value"):void 0}}(0,D.default)(".again-game").off().on("click",function(){var e,t,a=(new Date).getTime(),l=new Date(m),n=new Date(p);(0,D.default)(".game-over-alert-container").addClass("hidden"),(0,D.default)(".error-alert-container").addClass("hidden"),(0,D.default)(".share-container").addClass("hidden"),(0,D.default)(".qr-code-container").addClass("hidden"),g=30,h=1,r=250,(s=0,D.default)("#score").text(s),o=[],c.innerHTML="",u&&clearInterval(u),d&&clearInterval(d),M&&clearInterval(M),a<l&&((0,D.default)(".error-alert-container").removeClass("hidden"),(0,D.default)('.error-status[data-status="1"]').removeClass("hidden").siblings().addClass("hidden"),(0,D.default)(".start-time").text(m)),n<a&&((0,D.default)(".error-alert-container").removeClass("hidden"),(0,D.default)('.error-status[data-status="2"]').removeClass("hidden").siblings().addClass("hidden"),(0,D.default)(".end-time").text(p)),3==f&&(e=I.open_id,t=C,D.default.ajax({url:"/tools/tools-crm/get-selected.do",type:"GET",data:{open_id:e,activity_number:t},success:function(e){if(200==e.status){var t=e.data.player_info;if(Number(t.already_participate_number)>=Number(e.data.distribution_info.total_participate_times))return(0,D.default)(".audio-music")[0].pause(),(0,D.default)(".score-alert").text(s+"分"),u&&clearInterval(u),d&&clearInterval(d),M&&clearInterval(M),(0,D.default)(".error-alert-container").removeClass("hidden"),(0,D.default)('.error-status[data-status="5"]').removeClass("hidden").siblings().addClass("hidden"),void(0,D.default)(".confim-msg").off().on("click",function(){location.href="./?code="+_+"&state="+C});if(0==t.use_participate_number&&0==t.use_share_number)return(0,D.default)(".audio-music")[0].pause(),(0,D.default)(".score-alert").text(s+"分"),u&&clearInterval(u),d&&clearInterval(d),M&&clearInterval(M),(0,D.default)(".error-alert-container").removeClass("hidden"),(0,D.default)(".share-btn").addClass("hidden"),(0,D.default)('.error-status[data-status="4"]').removeClass("hidden").siblings().addClass("hidden"),void(0,D.default)(".confim-msg").off().on("click",function(){location.href="./?code="+_+"&state="+C});if(0==t.use_participate_number&&0<Number(t.use_share_number))return(0,D.default)(".audio-music")[0].pause(),(0,D.default)(".error-alert-close").addClass("hidden"),(0,D.default)(".score-alert").text(s+"分"),u&&clearInterval(u),d&&clearInterval(d),M&&clearInterval(M),(0,D.default)(".error-alert-container").removeClass("hidden"),(0,D.default)('.error-status[data-status="3"]').removeClass("hidden").siblings().addClass("hidden"),(0,D.default)("#share-btn").removeClass("hidden"),void(0,D.default)(".confim-msg").off().on("click",function(){location.href="./?code="+_+"&state="+C});E()}},error:function(e){H.default.alert(e.data.errMsg)}})),2==f&&E()}),L="红包来袭",N="玩游戏，赢大奖！",O=window.location.href,D.default.ajax({url:"/tools/sign-package/get-one.do",data:{url:O},success:function(e){wx.config({debug:!1,appId:e.data.appId,timestamp:e.data.timestamp,nonceStr:e.data.nonceStr,signature:e.data.signature,jsApiList:["checkJsApi","getLocation","chooseImage","uploadImage","onMenuShareWeibo","onMenuShareQZone","onMenuShareTimeline","onMenuShareAppMessage","onMenuShareQQ"]}),wx.ready(function(){wx.onMenuShareTimeline({title:L,link:location.origin+"/active",imgUrl:"",success:function(){D.default.ajax({url:"/tools/competition-set/post-one.do",type:"POST",data:{activity_number:C,open_id:I.open_id,share_success:1},success:function(e){200==e.status&&H.default.confirm("分享成功！是否重新开始游戏？",{title:"分享成功",buttons:[{label:"返回首页",type:"default",onClick:function(){location.href="./?code="+_+"&state="+C}},{label:"重新开始",type:"primary",onClick:function(){(0,D.default)(".again-game").click()}}]})}})},cancel:function(){}}),wx.onMenuShareAppMessage({title:L,desc:N,link:location.origin+"/active",imgUrl:"",type:"",dataUrl:"",success:function(){D.default.ajax({url:"/tools/competition-set/post-one.do",type:"POST",data:{activity_number:C,open_id:I.open_id,share_success:1},success:function(e){200==e.status&&H.default.confirm("分享成功！是否重新开始游戏？",{title:"分享成功",buttons:[{label:"返回首页",type:"default",onClick:function(){location.href="./?code="+_+"&state="+C}},{label:"重新开始",type:"primary",onClick:function(){(0,D.default)(".again-game").click()}}]})}})},cancel:function(){}}),wx.onMenuShareQQ({title:L,desc:N,link:location.origin+"/active",imgUrl:"",success:function(){D.default.ajax({url:"/tools/competition-set/post-one.do",type:"POST",data:{activity_number:C,open_id:I.open_id,share_success:1},success:function(e){200==e.status&&H.default.confirm("分享成功！是否重新开始游戏？",{title:"分享成功",buttons:[{label:"返回首页",type:"default",onClick:function(){location.href="./?code="+_+"&state="+C}},{label:"重新开始",type:"primary",onClick:function(){(0,D.default)(".again-game").click()}}]})}})},cancel:function(){}}),wx.onMenuShareWeibo({title:L,desc:N,link:location.origin+"/active",imgUrl:"",success:function(){D.default.ajax({url:"/tools/competition-set/post-one.do",type:"POST",data:{activity_number:C,open_id:I.open_id,share_success:1},success:function(e){200==e.status&&H.default.confirm("分享成功！是否重新开始游戏？",{title:"分享成功",buttons:[{label:"返回首页",type:"default",onClick:function(){location.href="./?code="+_+"&state="+C}},{label:"重新开始",type:"primary",onClick:function(){(0,D.default)(".again-game").click()}}]})}})},cancel:function(){}}),wx.onMenuShareQZone({title:L,desc:N,link:location.origin+"/active",imgUrl:"",success:function(){D.default.ajax({url:"/tools/competition-set/post-one.do",type:"POST",data:{activity_number:C,open_id:I.open_id,share_success:1},success:function(e){200==e.status&&H.default.confirm("分享成功！是否重新开始游戏？",{title:"分享成功",buttons:[{label:"返回首页",type:"default",onClick:function(){location.href="./?code="+_+"&state="+C}},{label:"重新开始",type:"primary",onClick:function(){(0,D.default)(".again-game").click()}}]})}})},cancel:function(){}})})},error:function(e){H.default.alert(e.data.errMsg)}}),d=setInterval(j,h),u=setInterval(W,r);var L,N,O;var P,U,Q,q=document.getElementById("puppet");q.addEventListener("touchstart",function(e){e.preventDefault(),P=e.touches[0].clientX-this.offsetLeft}),q.addEventListener("touchmove",function(e){(Q=e.touches[0].clientX-P)<5?Q="10px":Q>document.documentElement.clientWidth-this.offsetWidth&&(Q=document.documentElement.clientWidth-this.offsetWidth),U=Q+"px",this.style.left=U}),(0,D.default)('.follow[data-id="follow-us"]').on("click",function(){(0,D.default)(".qr-code-container").removeClass("hidden")}),(0,D.default)(".share-container").on("click",function(){(0,D.default)(this).addClass("hidden")}),(0,D.default)("#share-btn").on("click",function(){(0,D.default)(".share-container").removeClass("hidden")}),(0,D.default)(".qr-code-container").on("click",function(){(0,D.default)(this).addClass("hidden")}),(0,D.default)(".qr-code-img").on("click",function(e){e.stopPropagation()}),(0,D.default)(".music").off().on("click",function(){b?((0,D.default)(".audio-music")[0].pause(),(0,D.default)(this).addClass("music-disable")):((0,D.default)(".audio-music")[0].play(),(0,D.default)(this).removeClass("music-disable")),b=!b}),(0,D.default)(".close-follow").off().on("click",function(){var e=(0,D.default)(this).attr("data-id");(0,D.default)("."+e).addClass("hidden")}),(0,D.default)(".alert-close").off().on("click",function(){var e=(0,D.default)(this).attr("data-id");e&&((0,D.default)("."+e).hasClass("hidden")?(0,D.default)("."+e).removeClass("hidden"):(0,D.default)("."+e).addClass("hidden"))}),(0,D.default)(".error-alert-top-close").off().on("click",function(){location.href="./?code="+_+"&state="+C}),(0,D.default)(".to-index").off().on("click",function(){location.href="./?code="+_+"&state="+C})}()});